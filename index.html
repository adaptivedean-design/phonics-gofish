<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go-Fish Phonics P2P</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Game Constants ---
        const SET_NAMES = {
            'short-a': 'Short A (Cat, Hat)',
            'short-e': 'Short E (Bed, Hen)',
            'short-i': 'Short I (Pig, Bin)',
            'short-o': 'Short O (Dog, Hot)',
            'short-u': 'Short U (Sun, Bug)',
        };

        // --- Helper Functions ---
        const generateDeck = (selectedSets) => {
            const deck = [];
            selectedSets.forEach(set => {
                for (let i = 1; i <= 4; i++) {
                    deck.push({
                        id: `${set}-${i}-${Math.random()}`,
                        set: set,
                        name: `${set.replace('-', ' ')} ${i}`,
                    });
                }
            });
            return deck;
        };

        const shuffle = (array) => {
            const newArr = [...array];
            for (let i = newArr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
            }
            return newArr;
        };

        const GoFishPhonics = () => {
            // --- State ---
            const [gameState, setGameState] = useState('setup');
            const [playerName, setPlayerName] = useState('');
            const [opponentName, setOpponentName] = useState('');
            const [isMyTurn, setIsMyTurn] = useState(false);
            const [settings, setSettings] = useState({
                endTurnMode: 'always-draw',
                selectedSets: ['short-a', 'short-e', 'short-i']
            });

            const [myHand, setMyHand] = useState([]);
            const [opponentHandCount, setOpponentHandCount] = useState(0);
            const [deckCount, setDeckCount] = useState(0);
            const [myPeerId, setMyPeerId] = useState('');
            const [connected, setConnected] = useState(false);
            const [copied, setCopied] = useState(false);
            
            // Check URL to see if we are joining someone
            const [isHost] = useState(!new URLSearchParams(window.location.search).get('join'));
            
            const peerRef = useRef(null);
            const connRef = useRef(null);

            // --- PeerJS Logic ---
            useEffect(() => {
                const peer = new Peer();
                peerRef.current = peer;

                peer.on('open', (id) => {
                    setMyPeerId(id);
                    // If we are a guest, we have the ID but we haven't clicked 'Connect' yet
                });

                if (isHost) {
                    peer.on('connection', (connection) => {
                        connRef.current = connection;
                        setupConnection(connection);
                    });
                }

                return () => peer.destroy();
            }, [isHost]);

            const setupConnection = (connection) => {
                connection.on('open', () => {
                    setConnected(true);
                    // Sync Names
                    connection.send({ type: 'NAME_EXCHANGE', name: playerName || (isHost ? 'Host' : 'Guest') });
                });

                connection.on('data', (data) => {
                    if (data.type === 'NAME_EXCHANGE') {
                        setOpponentName(data.name);
                        // If I receive a name, I should send mine back so they know who I am
                        connection.send({ type: 'NAME_EXCHANGE_REPLY', name: playerName });
                    }
                    if (data.type === 'NAME_EXCHANGE_REPLY') {
                        setOpponentName(data.name);
                    }
                    if (data.type === 'START_GAME') {
                        setMyHand(data.hand);
                        setOpponentHandCount(data.oppHandCount);
                        setDeckCount(data.deckCount);
                        setSettings(data.settings);
                        setIsMyTurn(data.startingPlayer === 'guest');
                        setGameState('playing');
                    }
                });
            };

            const connectToOpponent = () => {
                const remoteId = new URLSearchParams(window.location.search).get('join');
                if (remoteId) {
                    const connection = peerRef.current.connect(remoteId);
                    connRef.current = connection;
                    setupConnection(connection);
                }
            };

            const startGame = () => {
                if (!connRef.current) return;

                const fullDeck = shuffle(generateDeck(settings.selectedSets));
                const hostHand = fullDeck.splice(0, 5);
                const guestHand = fullDeck.splice(0, 5);

                setMyHand(hostHand);
                setOpponentHandCount(guestHand.length);
                setDeckCount(fullDeck.length);
                setIsMyTurn(true);
                setGameState('playing');

                connRef.current.send({
                    type: 'START_GAME',
                    hand: guestHand,
                    oppHandCount: hostHand.length,
                    deckCount: fullDeck.length,
                    settings: settings,
                    startingPlayer: 'host' 
                });
            };

            const copyInviteLink = () => {
                const link = `${window.location.origin}${window.location.pathname}?join=${myPeerId}`;
                navigator.clipboard.writeText(link);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            // --- UI Screens ---
            if (gameState === 'setup') {
                return (
                    <div className="w-full min-h-screen bg-slate-100 p-4 flex items-center justify-center font-sans">
                        <div className="bg-white rounded-xl shadow-2xl p-8 max-w-lg w-full border border-slate-200">
                            <h1 className="text-3xl font-black text-center text-indigo-600 mb-6 italic">GO-FISH PHONICS</h1>
                            
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Your Display Name</label>
                                    <input
                                        type="text"
                                        value={playerName}
                                        onChange={(e) => setPlayerName(e.target.value)}
                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                                        placeholder="Enter name..."
                                    />
                                </div>

                                {isHost ? (
                                    <div className="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                                        <p className="text-sm font-semibold text-indigo-900 mb-2">Game Lobby</p>
                                        <div className="text-xs text-indigo-700 mb-4">
                                            {connected ? `✅ Opponent Joined: ${opponentName}` : "⏳ Waiting for someone to join..."}
                                        </div>
                                        <button onClick={copyInviteLink} className="w-full py-2 bg-white border border-indigo-300 rounded text-indigo-600 text-sm font-bold hover:bg-indigo-100 transition">
                                            {copied ? 'Link Copied!' : 'Copy Invite Link'}
                                        </button>
                                        <button 
                                            onClick={startGame} 
                                            disabled={!connected} 
                                            className={`w-full mt-4 py-3 rounded-lg font-bold text-white transition ${connected ? 'bg-indigo-600 hover:bg-indigo-700 shadow-lg' : 'bg-slate-300 cursor-not-allowed'}`}
                                        >
                                            START GAME
                                        </button>
                                    </div>
                                ) : (
                                    <div className="bg-emerald-50 p-4 rounded-lg border border-emerald-100">
                                        <p className="text-sm font-semibold text-emerald-900 mb-2">You've been invited!</p>
                                        <button 
                                            onClick={connectToOpponent} 
                                            disabled={connected} 
                                            className={`w-full py-3 rounded-lg font-bold text-white transition ${!connected ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-slate-300'}`}
                                        >
                                            {connected ? 'Connected - Waiting for Host' : 'Connect to Game'}
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="w-full h-screen bg-emerald-50 flex flex-col overflow-hidden">
                    {/* Header */}
                    <div className="bg-white border-b px-6 py-3 flex justify-between items-center shadow-sm">
                        <div className="flex flex-col">
                            <span className="text-[10px] uppercase font-bold text-slate-400">Current Turn</span>
                            <span className="font-bold text-indigo-600">{isMyTurn ? "YOUR TURN" : `${opponentName}'s Turn`}</span>
                        </div>
                        <div className="flex gap-6">
                            <div className="text-right">
                                <span className="text-[10px] uppercase font-bold text-slate-400">{playerName}</span>
                                <div className="font-black text-indigo-600">{myHand.length} Cards</div>
                            </div>
                            <div className="text-right border-l pl-6">
                                <span className="text-[10px] uppercase font-bold text-slate-400">{opponentName}</span>
                                <div className="font-black text-rose-500">{opponentHandCount} Cards</div>
                            </div>
                        </div>
                    </div>

                    {/* Table Area */}
                    <div className="flex-1 flex flex-col items-center justify-between py-10">
                        {/* Opponent Cards */}
                        <div className="flex gap-[-20px]">
                            {[...Array(opponentHandCount)].map((_, i) => (
                                <div key={i} className="w-16 h-24 bg-indigo-600 rounded-lg shadow-md border-2 border-white -ml-4 first:ml-0 transform hover:-translate-y-2 transition cursor-help" />
                            ))}
                        </div>

                        {/* Deck */}
                        <div className="relative group">
                            <div className="w-24 h-32 bg-slate-800 rounded-xl shadow-2xl flex items-center justify-center text-white border-4 border-slate-700">
                                <span className="text-3xl font-black">{deckCount}</span>
                            </div>
                            <p className="absolute -bottom-6 left-1/2 -translate-x-1/2 text-[10px] font-bold text-slate-400 whitespace-nowrap uppercase tracking-widest">Draw Pile</p>
                        </div>

                        {/* Player Hand */}
                        <div className="flex gap-2 px-4 overflow-x-auto pb-4 max-w-full">
                            {myHand.map((card) => (
                                <div key={card.id} className="min-w-[80px] h-28 bg-white rounded-lg shadow-xl border-2 border-indigo-200 flex flex-col items-center justify-center p-2 text-center hover:scale-105 hover:border-indigo-500 transition cursor-pointer">
                                    <span className="text-[10px] text-slate-400 font-bold uppercase">{card.set}</span>
                                    <span className="text-xs font-black text-slate-800">{card.name}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GoFishPhonics />);
    </script>
</body>
</html>
